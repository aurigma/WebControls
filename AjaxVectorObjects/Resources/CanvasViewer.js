Type.registerNamespace("Aurigma.GraphicsMill.AjaxControls"),Aurigma.GraphicsMill.AjaxControls.CanvasViewer=function(n){Aurigma.GraphicsMill.AjaxControls.CanvasViewer.initializeBase(this,[n]),this._canvasId=null,this._canvasSaveStateDelegate=null,this._bitmapViewerSaveStateDelegate=null,this._mouseMoveDelegate=null,this._mouseUpDelegate=null,this._mouseDownDelegate=null,this._doubleClickDelegate=null,this._zoomDelegate=null,this._resizeDelegate=null,this._keyDownDelegate=null,this._keyUpDelegate=null,this._modalBgClass=null,this._clearSelectionOnDocumentClick=!0,this._devicePixelRatio=1,this._resizeCheckIntervalId=null},Aurigma.GraphicsMill.AjaxControls.CanvasViewer.preventKeyHandleClass="preventCanvasKeyHandle",Aurigma.GraphicsMill.AjaxControls.CanvasViewer.preventClickHandleClass="preventCanvasClickHandle",Aurigma.GraphicsMill.AjaxControls.CanvasViewer.prototype={get_canvasId:function(){return this._canvasId},set_canvasId:function(n){this._canvasId=n},get_canvas:function(){if(this.get_canvasId()){var n=$find(this.get_canvasId());return n?(this.get_canvas=function(){return n},this.get_canvas()):null}return null},get_contentWidth:function(){return Math.round(this.get_workspaceWidth()*this.get_zoom()*this.get_actualSizeHorizontalScale())},get_contentHeight:function(){return Math.round(this.get_workspaceHeight()*this.get_zoom()*this.get_actualSizeVerticalScale())},get_workspaceWidth:function(){return this.get_canvas().get_workspaceWidth()},get_workspaceHeight:function(){return this.get_canvas().get_workspaceHeight()},get_actualSizeHorizontalScale:function(){return this.get_canvas().get_screenXDpi()/this.get_canvas().get_devicePixelRatio()/72},get_actualSizeVerticalScale:function(){return this.get_canvas().get_screenYDpi()/this.get_canvas().get_devicePixelRatio()/72},get_modalBgClass:function(){return this._modalBgClass},set_modalBgClass:function(n){this._modalBgClass=n},get_clearSelectionOnDocumentClick:function(){return this._clearSelectionOnDocumentClick},set_clearSelectionOnDocumentClick:function(n){this._clearSelectionOnDocumentClick=n},_renderContent:function(n){var i="width:"+this.get_contentWidth()+"px;height:"+this.get_contentHeight()+"px;",t="position:absolute;left:0px;top:0px;z-index:1";n.append('<div id="cvImage" style="'),n.append(i),n.append(t+'"/>')},set_zoomMode:function(n){Aurigma.GraphicsMill.AjaxControls.CanvasViewer.callBaseMethod(this,"set_zoomMode",[n]);var t=this.get_canvas();t.set_zoom(this.get_zoom()),t.redraw()},set_zoom:function(n,t){(typeof n!="number"||n<this.get_minZoom())&&(n=this.get_minZoom());var i=this.get_canvas();n=i._calculateZoom(n),Aurigma.GraphicsMill.AjaxControls.CanvasViewer.callBaseMethod(this,"set_zoom",[n,t]),i.set_zoom(n),i.redraw()},_onDocumentClick:function(n){if(this._ignoreDocumentClickOnce===!0){this._ignoreDocumentClickOnce=!1;return}Aurigma.GraphicsMill.AjaxControls.CanvasViewer.callBaseMethod(this,"_onDocumentClick",[n]);if(this.get_clearSelectionOnDocumentClick()&&!this._ignoreSelectionClick(n)){var t=this.get_canvas();t&&(t.clearSelectedVObjects(),t.redraw())}},_ignoreSelectionClick:function(n){var r=Aurigma.GraphicsMill.Utils,i=Aurigma.GraphicsMill.AjaxControls.CanvasViewer,t=this._jquery.contains(this.get_element(),n.target);return t?!0:r.isEventPathContainsClass(n,i.preventClickHandleClass)},_onMouseDown:function(n){Aurigma.GraphicsMill.AjaxControls.CanvasViewer.callBaseMethod(this,"_onMouseDown",[n]);if(n.target==this.get_element()){var t=this.get_canvas();t&&(t.clearSelectedVObjects(),t.redraw())}},_onMouseMove:function(n){Aurigma.GraphicsMill.AjaxControls.CanvasViewer.callBaseMethod(this,"_onMouseMove",[n]),n.preventDefault()},_onTouch:function(n){Aurigma.GraphicsMill.AjaxControls.CanvasViewer.callBaseMethod(this,"_onTouch",[n]),this._touchFlags.isScroll=!0,this._touchFlags.isScrollChecked=!1,this._touchFlags.gestureCenter=null,this._touchFlags.lastPinchEvent=null,this._touchFlags.initialCurrentLeft=this._jHolderElement.scrollLeft(),this._touchFlags.initialCurrentTop=this._jHolderElement.scrollTop()},_onPinch:function(n){var t,u,r,i;this._touchFlags.mouseDown.onTimeout!==null&&(clearTimeout(this._touchFlags.mouseDown.timeout),this._touchFlags.mouseDown.onTimeout=null),t=this._touchFlags,t.gestureCenter==null&&(t.gestureCenter=n.gesture.center),t.lastPinchEvent=n,t.isScroll?(u=t.initialCurrentLeft+(t.gestureCenter.pageX-n.gesture.center.pageX),r=t.initialCurrentTop+(t.gestureCenter.pageY-n.gesture.center.pageY),this.set_scrollingPosition({x:u,y:r})):(!Aurigma.GraphicsMill.Utils.Platform.IsIos()||Aurigma.GraphicsMill.Utils.Platform.IosMajorVersion()>5)&&Aurigma.GraphicsMill.AjaxControls.CanvasViewer.callBaseMethod(this,"_onPinch",[n]),!t.isScrollChecked&&this.get_pinchZoomEnabled()&&n.gesture.deltaTime>350&&(t.isScrollChecked=!0,i=this._calcAngle(n.gesture.touches[0],n.gesture.touches[1],t.gestureCenter),this._isPinchByAngle(i,n.gesture.scale)&&this._isPinchByModule(n.gesture.touches[0],n.gesture.touches[1],t.gestureCenter)&&(t.isScroll=!1,Aurigma.GraphicsMill.AjaxControls.CanvasViewer.callBaseMethod(this,"_onPinch",[n])))},_onRelease:function(n){var t=this._touchFlags,i;this.get_pinchZoomEnabled()&&!t.isScrollChecked&&t.lastPinchEvent!=null&&(i=this._calcAngle(t.lastPinchEvent.gesture.touches[0],t.lastPinchEvent.gesture.touches[1],t.gestureCenter),this._isPinchByAngle(i,t.lastPinchEvent.gesture.scale)&&Aurigma.GraphicsMill.AjaxControls.CanvasViewer.callBaseMethod(this,"_onPinch",[t.lastPinchEvent])),Aurigma.GraphicsMill.AjaxControls.CanvasViewer.callBaseMethod(this,"_onRelease",[n])},_isPinchByAngle:function(n,t){return Aurigma.GraphicsMill.Utils.Platform.IsTouchIE()?n>=160||t<=.85||t>=1.3:n>=160&&(t<=.85||t>=1.3)},_isPinchByModule:function(n,t,i){var u=[n.pageX-i.pageX,n.pageY-i.pageY],r=[t.pageX-i.pageX,t.pageY-i.pageY],s=Math.sqrt(Math.pow(u[0],2)+Math.pow(u[1],2)),o=Math.sqrt(Math.pow(r[0],2)+Math.pow(r[1],2)),f=[u[0]+r[0],u[1]+r[1]],e=Math.sqrt(Math.pow(f[0],2)+Math.pow(f[1],2));return e<s&&e<o},_calcAngle:function(n,t,i){var u=[n.pageX-i.pageX,n.pageY-i.pageY],r=[t.pageX-i.pageX,t.pageY-i.pageY],e=parseFloat(u[0]*r[0]+u[1]*r[1])/(Math.sqrt(Math.pow(u[0],2)+Math.pow(u[1],2))*Math.sqrt(Math.pow(r[0],2)+Math.pow(r[1],2)));return 180*Math.acos(e)/Math.PI},initialize:function(){var u,n,r,t,f,i;Aurigma.GraphicsMill.AjaxControls.CanvasViewer.callBaseMethod(this,"initialize"),this._jHolderElement.css("-ms-touch-action","none"),this._jHolderElement.css("touch-action","none"),u=this._contentElements,u.push(this._imageCtx=this._jquery(this.get_element()).find("#cvImage")[0]),n=this.get_canvas(),n._viewer=this,n._addPlaceholderButtonStyles(),r=this._contentCtx.firstChild,this._canvasSaveStateDelegate||(this._canvasSaveStateDelegate=Function.createDelegate(n,n._saveState)),this.add_invokingCallbackRequest(this._canvasSaveStateDelegate),this._bitmapViewerSaveStateDelegate||(this._bitmapViewerSaveStateDelegate=Function.createDelegate(this,this._saveState)),n.add_invokingCallbackRequest(this._bitmapViewerSaveStateDelegate),this._onCanvasStatusChangedDelegate||(this._onCanvasStatusChangedDelegate=Function.createDelegate(this,this._onCanvasStatusChanged),n.add_statusChanged(this._onCanvasStatusChangedDelegate)),f=function(){n.get_status()==Aurigma.GraphicsMill.UpdateStatus.ready&&n.get_isInitialized()&&(n.remove_statusChanged(t),n.remove_initialized(t),t=null,n.set_zoom(this.get_zoom(),!0),n._addElement(r),n.redraw(!0))},n.get_status()==Aurigma.GraphicsMill.UpdateStatus.ready&&n.get_isInitialized()?(n.set_zoom(this.get_zoom(),!0),n._addElement(r),n.redraw(!0)):(t=Function.createDelegate(this,f),n.add_statusChanged(t),n.add_initialized(t)),i=function(n){var i=Aurigma.GraphicsMill.Utils,t=Aurigma.GraphicsMill.AjaxControls.CanvasViewer;return i.isEventPathContainsClass(n,t.preventKeyHandleClass)?!0:(n.keyCode<37||n.keyCode>40)&&n.keyCode!==Sys.UI.Key.del},this._keyUpDelegate=Function.createDelegate(this,function(t){if(i(t))return;n.raiseKeyUp(t),t.preventDefault()}),this._keyDownDelegate=Function.createDelegate(this,function(t){if(i(t))return;n.raiseKeyDown(t),t.preventDefault()}),$addHandler(document,"keyup",this._keyUpDelegate),$addHandler(document,"keydown",this._keyDownDelegate),this._touchFlags.mouseDown={onTimeout:null},this._mouseDownDelegate=Function.createDelegate(this,function(t,i){if(this.get_navigator()==""&&this.get_rubberband()==""){this.get_element().focus();if(i.type=="touchstart"||i.type=="MSPointerDown"||i.type=="pointerDown"){var r=function(){n.raiseMouseDown(i)};this._touchFlags.mouseDown.onTimeout=r,this._touchFlags.mouseDown.timeout=setTimeout(r,250)}else n.raiseMouseDown(i)}return!0}),this.add_workspaceMouseDown(this._mouseDownDelegate),this._doubleClickDelegate=Function.createDelegate(this,function(t,i){return this.get_navigator()==""&&this.get_rubberband()==""&&(this.get_element().focus(),n.raiseDoubleClick(i)),!0}),this.add_workspaceDoubleClick(this._doubleClickDelegate),this._mouseMoveDelegate=Function.createDelegate(this,function(t,i){return this._touchFlags.mouseDown.onTimeout!==null&&(clearTimeout(this._touchFlags.mouseDown.timeout),this._touchFlags.mouseDown.onTimeout(),this._touchFlags.mouseDown.onTimeout=null),this.get_navigator()==""&&this.get_rubberband()==""&&n.raiseMouseMove(i),!0}),this.add_workspaceMouseMove(this._mouseMoveDelegate),this._mouseUpDelegate=Function.createDelegate(this,function(t,i){return this._touchFlags.mouseDown.onTimeout!==null&&(clearTimeout(this._touchFlags.mouseDown.timeout),this._touchFlags.mouseDown.onTimeout(),this._touchFlags.mouseDown.onTimeout=null),this.get_navigator()==""&&this.get_rubberband()==""&&n.raiseMouseUp(i),!0}),this.add_workspaceMouseUp(this._mouseUpDelegate),this._resizeDelegate=Function.createDelegate(this,this._onResize),n.add_workspaceSizeChanged(this._resizeDelegate),this._resizeCheckIntervalId=setInterval(function(){this._devicePixelRatio!==n.get_devicePixelRatio()&&(this._devicePixelRatio=n.get_devicePixelRatio(),this._onResize())}.bind(this),500)},_onResize:function(){Aurigma.GraphicsMill.AjaxControls.CanvasViewer.callBaseMethod(this,"_onResize");var n=this.get_canvas();n.set_zoom(this.get_zoom()),n._updateCanvasElementSize(),n.redraw(!0)},_onCanvasStatusChanged:function(){this.get_canvas().get_status()==Aurigma.GraphicsMill.AjaxControls.VectorObjects.UpdateStatus.busy?this.lockViewer():this.unlockViewer()},lockViewer:function(){var i,t,n;this._isViewerLocked=!0,i=this.get_element(),t=$get(this.get_id()+"_modalBg"),t||(t=document.createElement("div"),n=t.style,n.position="absolute",n.top="0",n.left="0",this._modalBgClass?t.className=this._modalBgClass:(n.backgroundPosition="50% 50%",n.backgroundColor="#000000",n.opacity="0.4",n.filter="alpha(opacity=40)",n.zIndex="1000"),t.id=this.get_id()+"_modalBg",i.offsetParent&&i.offsetParent.appendChild(t),n.width="100%",n.height="100%",n.bottom="0",n.right="0"),t.style.display="block"},unlockViewer:function(){this._isViewerLocked=!1;var n=$get(this.get_id()+"_modalBg");n&&(n.style.display="none")},dispose:function(){this._resizeCheckIntervalId!=null&&clearInterval(this._resizeCheckIntervalId);var n=this.get_canvas();n&&(this._mouseUpDelegate&&(this.remove_workspaceMouseUp(this._mouseUpDelegate),this._mouseUpDelegate=null),this._mouseDownDelegate&&(this.remove_workspaceMouseDown(this._mouseDownDelegate),this._mouseDownDelegate=null),this._mouseMoveDelegate&&(this.remove_workspaceMouseMove(this._mouseMoveDelegate),this._mouseMoveDelegate=null),this._doubleClickDelegate&&(this.remove_workspaceDoubleClick(this._doubleClickDelegate),this._doubleClickDelegate=null),this._zoomDelegate&&(this.remove_zoomed(this._zoomDelegate),this._zoomDelegate=null),this._onCanvasStatusChangedDelegate&&(n.remove_statusChanged(this._onCanvasStatusChangedDelegate),delete this._onCanvasStatusChangedDelegate),this._resizeDelegate&&(n.remove_workspaceSizeChanged(this._resizeDelegate),delete this._resizeDelegate)),Aurigma.GraphicsMill.AjaxControls.CanvasViewer.callBaseMethod(this,"dispose")},_refresh:function(){this._refreshTimer&&window.clearTimeout(this._refreshTimer),this._needToRefresh=!1}},Aurigma.GraphicsMill.AjaxControls.CanvasViewer.registerClass("Aurigma.GraphicsMill.AjaxControls.CanvasViewer",Aurigma.GraphicsMill.BaseViewer);